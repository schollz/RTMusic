<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="chrome=1" />
  <script src="http://socket-logs.herokuapp.com/socket.io/socket.io.js"></script>
  <title>Binaryjs Audio</title>
  <script src="http://cdn.binaryjs.com/0/binary.js"></script>
  <script src="http://code.jquery.com/jquery-1.10.2.min.js"></script>
  <link rel="stylesheet" href="/bootstrap.min.css">
  <link rel="stylesheet" href="/style.css">
</head>
<body style="background-size:cover">
<div class="container">
  <div class="row">
  	<input type="file" id="fileinput" accept="audio/*" />
    <button onclick="emitPlay()" >Start</button>
    <button onclick="emitStop()" >Stop</button>
  </div>
  <div class="row">
    <div class="col-md-4">
      <div id="slaveTime">
        <h1>Slaves</h1>
      </div>  
    </div>
    <div class="col-md-4">
      <div id="serverTime">
        <h1>Server</h1>
      </div>
    </div>
    <div class="col-md-4">
      <div id="masterTime">
        <h1>Master</h1>
      </div>
    </div>
  </div>
</div>
	<script>

  var minutes=1000*60;
  var hours=minutes*60;
  var days=hours*24;
  var years=days*365;
  var seconds = minutes * 60;
  var miliseconds = seconds * 1000;


	var context = new window.webkitAudioContext();
	var source = null;
	var audioBuffer = null;
  var parts = [];
  var fileReader = new FileReader();

  //Stream source?
  var streamingAudioSource = 0;
  var streamData = [];
  var startTime = 0;
  var startOffset = 0;
  var isBufferReady = 1;
  var shouldPlay = 0;


  var binaryHost = location.origin.replace(/^http/, 'ws');
	var client = new BinaryClient(binaryHost + '/binary-endpoint');

  var socket = io.connect('http://socket-logs.herokuapp.com');
  socket.on('init', function (data){
    console.log(data);
  });

	client.on('stream', function(stream, meta){
    var begin = new Date();
		var start = begin.getTime();
    var laststep = new Date().getTime();
    	// var test = new MediaSource();
    	// var audio = document.createElement("audio");
    	// audio.src = (window.URL || window.webkitURL).createObjectURL(test);
      
      // Reset Variables
      if(source){
        source.noteOff(0);
      }
      source = null;
      audioBuffer = null;
      parts = [];
      streamData = [];
      startTime = 0;
      startOffset = 0;

    socket.emit('slaveStartStreamSend', start);

      var size = 0;

    	stream.on('data', function(data){
        shouldPlay = 1;
    		var now = new Date().getTime();
    		console.log("time since last buffer received: " + (now-laststep) + " ms");
    		laststep = new Date().getTime();
      	parts.push(data);
        size += data.byteLength;
        streamData.push(data);
        streamAudio();
    	});
    	stream.on('end', function(){
    		var now = new Date().getTime();
    		console.log("time to fetch all data: " + (now-start) + " ms");
      		console.log("total buffers: " + parts.length + " , total size: " + (size/1000000) + " mb");
      		//initSound(parts);
          //var blob = new Blob(parts);
          //fileReader.readAsArrayBuffer(blob);
          console.log("past filereader");
    	});
	});

  function streamAudio(){
    if(isBufferReady){
      var blob = new Blob(streamData);
      fileReader.readAsArrayBuffer(blob);
      isBufferReady = 0;
    }
  }

  function createStream(){
    //streamingAudioSource = context.createMediaStreamSource(streamData);

  }

	var fileInput = document.querySelector('input[type="file"]');
	fileInput.addEventListener('change', function(event){
        var file = event.target.files[0];
        client.send(file);
        var now = new Date();
        socket.emit('masterSend', now.getTime());
        console.log('sending data at this time ' + now + ' miliseconds ' + now.getMilliseconds());
        fileReader.readAsArrayBuffer(file);
    }, false);

  fileReader.onloadend =  function(e){

    initSound(fileReader.result);
    console.log("sound shoud be playing");

    // Get more blobs when finished:
    isBufferReady = 1;

  };

  function initSound(buf) {
  	context.decodeAudioData(buf, function(buffer) {
  		audioBuffer = buffer;
      playLocal();
  	}, function(e) {
  		console.log('Error decoding file', e);
		});
  }

function stopLocal() {
  if (source) {
    source.noteOff(0);
    startOffset += context.currentTime - startTime;
    shouldPlay = 0;
    startTime = context.currTime;
  }
}

function playLocal() {
  if(shouldPlay){
    if (source) {
      source.noteOff(0);
      startOffset += context.currentTime - startTime;
    }
    startTime = context.currentTime;
    source = context.createBufferSource();
    source.buffer = audioBuffer;
    source.loop = false;
    source.connect(context.destination);
    source.start(0, startOffset);
  }
}


socket.on('play', function (data) {
  // var text = document.getElementById('text').value;
  // if (data != text) {
    console.log('playing');
    playLocal();
    shouldPlay = 1;
  // }
});
socket.on('pause', function (data) {
  // var text = document.getElementById('text').value;
  // if (data != text) {
    console.log('stopping');
    stopLocal();
  // }
});

socket.on('slaveStartStreamTime', function (data){
  var p = '<p>' + data + '</p>';
  $('#slaveTime').append(p);
});


socket.on('masterTime', function (data){

  var h = Math.round(data/hours);
  var s = Math.round(data/seconds);
  var m = Math.round(data/miliseconds);
  var p = '<p>' + h + ':' + s + ':<strong>' + m + '</strong></p>';
  $('#masterTime').append(p);
});


function emitPlay(){
  socket.emit('play', 'yes');
  // shouldPlay = 1;
}

function emitStop(){
  socket.emit('pause', 'yes');
}

  </script>
</body>
</html>